<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hna.hka.archive.management.assetsSystem.dao.OrderStatisticsMapper">

    <select id="findData" resultType="java.util.HashMap">
        SELECT
        dos.NAME as 订单状态,
        COUNT(so.ORDER_ID) as 订单数量,
        IFNULL(SUM(ROUND(so.ACTUAL_AMOUNT , 2)) , 0) as 订单计费金额,
        IFNULL(SUM(ROUND(so.ORDER_REFUND_AMOUNT , 2)) , 0) as 退款金额,
        IFNULL(SUM(ROUND(so.ORDER_AMOUNT - so.ORDER_REFUND_AMOUNT + so.DEDUCTIBLE_AMOUNT , 2)) , 0) as 实际收入金额,
        IFNULL(SUM(ROUND( (so.ORDER_AMOUNT - so.ORDER_REFUND_AMOUNT + so.DEDUCTIBLE_AMOUNT) * 0.994 , 2)) , 0) as 最终入账金额
        from
        D_ORDER_STATUS dos
        left join SYS_ORDER so on
        dos.STATUS = (CASE WHEN so.ORDER_STATUS = 30 AND so.ORDER_REFUND_AMOUNT &lt;&gt; 0 THEN 70 ELSE so.ORDER_STATUS END)
        <if test="beginTime != null and beginTime != ''">
            and substr(so.CREATE_DATE , 1 , 10) &gt;= #{beginTime}
        </if>
        <if test="endTime != null and endTime != ''">
            and substr(so.CREATE_DATE , 1 , 10) &lt;= #{endTime}
        </if>
        <if test="spotId != null">
            and so.ORDER_SCENIC_SPOT_ID = #{spotId}
        </if>
        left join SYS_SCENIC_SPOT sss on
        so.ORDER_SCENIC_SPOT_ID = sss.SCENIC_SPOT_ID
        <if test="companyId != null">
            and sss.COMPANY_ID = #{companyId}
        </if>
        GROUP BY
        dos.STATUS
        order by
        dos.STATUS
    </select>
</mapper>