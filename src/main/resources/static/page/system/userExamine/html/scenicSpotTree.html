<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>权限设置--后台管理系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css" media="all" />
    <link rel="stylesheet" href="/css/common.css" media="all" />
    <link rel="stylesheet" href="/zTree_v3/css/zTreeStyle/zTreeStyle.css" media="all">
</head>

<body>
<div id="deptForm" class="layui-fluid">
    <div class="zTreeDemoBackground left">
        <ul id="treeDemo" class="ztree"></ul>
        <input name="roleId" type="hidden" class="roleId"/>
        <input name="userId" type="hidden" class="userId"/>
    </div>
    <br>
    <div class="home-search">
        <div class="search-box">
            <form class="layui-form" action="">
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <select name="roleId" lay-verify="required" lay-filter="group" lay-search="" id="sele">
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <br>
    <div class="layui-row" style="background: #CFD4D5;padding: 10px;">
        <div style="text-align: center;">
            <button class="layui-btn layui-btn-sm" id="saveButton">保存</button>
            <button class="layui-btn layui-btn-sm layui-btn-primary" type="button" onclick="cancels()">取消</button>
        </div>
    </div>
</div>
</body>


<script type="text/javascript" src="/layui/layui.js"></script>
<script type="text/javascript" src="/zTree_v3/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="/zTree_v3/js/jquery.ztree.all.min.js"></script>
<script type="text/javascript">
    var $,tab,dataStr,layer;
    $(function () {
        var parent_json = eval('('+parent.json+')');//获取父级参数
        var setting = {
            view : {
                addHoverDom : false,
                removeHoverDom : false,
                selectedMulti : false
            },
            data : {
                key : {
                    name : "scenicSpotFname"
                },
                simpleData : {
                    enable : true,
                    idKey : "scenicSpotFid",
                    pIdKey : "scenicSpotPid",
                    rootPId : 0
                }
            },
            check : {
                enable : true,
                chkStyle : "checkbox",
                chkboxType: { "Y": "ps", "N": "ps" }
            },
            callback:{
                onCheck:onCheck
            }
        };
        $.ajax({
            url:"/system/user/getScenicSpotRole",
            type:"POST",
            data:{
                userId : parent_json.userId
            },
            dataType:"json",
            success:function(data){
                if (data.state == "200"){
                    zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, data.data);//初始化操作
                }else if (data.state == "201"){
                    top.layer.msg(data.msg, {icon: 6});
                    parent.layer.closeAll("iframe");
                }else{
                    top.layer.msg(data.msg, {icon: 5,time: 1000,shift: 6});
                }
            }
        });
        getScenicspotRole();
    });
    var scenicSpots;
    //树节点点击事件
    function onCheck(e, treeId, zNodes) {
        var resId = "";
        var nodes = zTreeObj.getCheckedNodes(true);
        for (var i = 0; i < nodes.length; i++) {
            resId += nodes[i].scenicSpotFid + ",";
        }
        scenicSpots = resId
    }

    /**
     * 提交权限
     */
    $("#saveButton").click(function () {
        if ($("#sele").val() == ""){
            top.layer.msg("请选择角色后进行保存", {icon: 5,time: 1000,shift: 6});
            return false;
        }
        var index = top.layer.msg('数据提交中，请稍候',{icon: 16,time:false,shade:0.8});
        $.ajax({
            url:"/system/user/addScenicSpotRole",
            type:"POST",
            data:{
                roleId : $(".roleId").val(),
                userId : $(".userId").val(),
                scenicSpots : scenicSpots
            },
            dataType:"json",
            success:function(data){
                if (data.state == "200"){
                    top.layer.close(index);
                    top.layer.msg(data.msg, {icon: 6});
                    parent.layer.closeAll("iframe");
                }else if (data.state == "400"){
                    top.layer.msg(data.msg, {icon: 5,time: 1000,shift: 6});
                }
            }
        });
    })
    layui.use(['form','element','layer','jquery'],function(){
        var form = layui.form;
        var element = layui.element;
        var $ = layui.$;
        var layer = layui.layer;

        form.on('select(group)',function(data){
            $(".roleId").val(data.value);
        })
        form.render('select','group');
    });
    function getScenicspotRole(){
        var items = [];
        $.ajax({
            type : "post",
            url : "/system/role/getScenicSpotRole",
            async : false,
            success : function(data){
                if(data.state == 200){
                    items = data.data;
                    var htt = '<option value="">请选择</option>';
                    $.each(items, function (k, v) {
                        htt += '<option value="'+ items[k].roleId +'">'+items[k].roleName+'</option>'
                    });
                    $("#sele").html(htt);
                }else{
                }
            }
        });
    }
</script>

</body>

</html>
