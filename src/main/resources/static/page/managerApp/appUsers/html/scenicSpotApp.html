<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>APP用户分配权限--后台管理系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css" media="all" />
    <link rel="stylesheet" href="/css/common.css" media="all" />
    <link rel="stylesheet" href="/zTree_v3/css/zTreeStyle/zTreeStyle.css" media="all">
</head>

<body>
<div id="deptForm" class="layui-fluid">
    <div class="zTreeDemoBackground left">
        <ul id="treeDemo" class="ztree"></ul>
        <input name="userId" type="hidden" class="userId"/>
    </div>
    <br>
    <div class="home-search">
        <div class="search-box">
            <form class="layui-form" action="">
                <div class="layui-inline">
                    <div class="layui-input-inline">
                        <select name="roleId" class="roleId" lay-verify="required" lay-filter="group" lay-search="" id="sele">
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <br>
    <div class="layui-row" style="background: #CFD4D5;padding: 10px;">
        <div style="text-align: center;">
            <button class="layui-btn layui-btn-sm" id="saveButton">保存</button>
            <button class="layui-btn layui-btn-sm layui-btn-primary" type="button" onclick="cancels()">取消</button>
        </div>
    </div>
</div>
</body>


<script type="text/javascript" src="/layui/layui.js"></script>
<script type="text/javascript" src="/zTree_v3/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="/zTree_v3/js/jquery.ztree.all.min.js"></script>
<script type="text/javascript">
    // var $,tab,dataStr,layer;
    // $(function () {
    //     var parent_json = eval('('+parent.json+')');//获取父级参数
    //     var setting = {
    //         view : {
    //             addHoverDom : false,
    //             removeHoverDom : false,
    //             selectedMulti : false
    //         },
    //         data : {
    //             key : {
    //                 name : "scenicSpotFname"
    //             },
    //             simpleData : {
    //                 enable : true,
    //                 idKey : "scenicSpotFid",
    //                 pIdKey : "scenicSpotPid",
    //                 rootPId : 0
    //             }
    //         },
    //         check : {
    //             enable : true,
    //             chkStyle : "checkbox",
    //             chkboxType: { "Y": "ps", "N": "ps" }
    //         },
    //         callback:{
    //             onCheck:onCheck,
    //             beforeCheck : function(treeId, treeNode) {
    //                                 if (treeNode.children) {
    //                                     layer.msg('父节点不可选择');
    //                                     return false;
    //                                 }
    //                             }
    //         }
    //     };
    //     $.ajax({
    //         url:"/system/appUsers/getScenicSpotList",
    //         type:"POST",
    //         data:{
    //             userId : parent_json.userId
    //         },
    //         dataType:"json",
    //         success:function(data){
    //             zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, data.data);//初始化操作
    //             zTreeObj.expandAll(true);
    //             echoZtree();
    //         }
    //     });
    //     getScenicspotRole();
    // });


    getScenicspotRole();
    layui.use(['layer','tree'], function() {
        var setting = {
            view : {
                addHoverDom : false,
                removeHoverDom : false,
                selectedMulti : false
            },
            data : {
                key : {
                    name : "scenicSpotFname"
                },
                simpleData : {
                    enable : true,
                    idKey : "scenicSpotFid",
                    pIdKey : "scenicSpotPid",
                    rootPId : -1
                }
            },
            check : {
                enable : true,
                chkStyle : "checkbox",
                chkboxType: { "Y": "s", "N": "ps" }
            },
            callback:{
                onCheck:onCheck,
                beforeCheck : function(treeId, treeNode) {
                    if (treeNode.children) {
                        layer.msg('父节点不可选择');
                        return false;
                    }
                }
            }
        };
        $.ajax({
            url:"/system/appUsers/getScenicSpotList",
            type:"get",
            dataType:"json",
            success:function(data){
                zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, data.data);//初始化操作
                zTreeObj.expandAll(true);
                echoZtree();
            }
        });

    });
    //回显树节点
    function echoZtree(){
        $.ajax({
            url:"/system/appUsers/getScenicSpotzTree",
            type:"get",
            data:{
                userId : $(".userId").val()
            },
            dataType:"json",
            success:function(data){
                if (data.state == "200"){
                    for(var i = 0; i < data.data.length; i++) {
                        var node = zTreeObj.getNodeByParam("scenicSpotFid", data.data[i].primaryKeyPid);
                        if(node != null) {
                            zTreeObj.checkNode(node, true)
                        }
                    }
                }else if (data.state == "400"){
                    top.layer.msg(data.msg, {icon: 5,time: 1000,shift: 6});
                }
            }
        });
    }
    var scenicSpotFids;
    //树节点点击事件
    function onCheck(e, treeId, zNodes) {
        var scenicSpotFid = "";
        var nodes = zTreeObj.getCheckedNodes(true);
        for (var i = 0; i < nodes.length; i++) {
            scenicSpotFid += nodes[i].scenicSpotFid + ",";
        }
        scenicSpotFids = scenicSpotFid
    }

    /**
     * 提交权限
     */
    $("#saveButton").click(function () {
        var index = top.layer.msg('数据提交中，请稍候',{icon: 16,time:false,shade:0.8});
        $.ajax({
            url:"/system/appUsers/addRoleScenicSpot",
            type:"POST",
            data:{
                userId : $(".userId").val(),
                scenicSpotId : scenicSpotFids.substring(0, scenicSpotFids.lastIndexOf(',')),
                //景区管理员app权限
                // roleId : 1542856508899107
                //景区系统管理员权限
                // roleId : 15223022263422
                roleId : $(".roleId").val(),
            },
            dataType:"json",
            success:function(data){
                if (data.state == "200"){
                    top.layer.close(index);
                    top.layer.msg(data.msg, {icon: 6});
                    parent.layer.closeAll("iframe");
                }else if (data.state == "400"){
                    top.layer.msg(data.msg, {icon: 5,time: 1000,shift: 6});
                }
            }
        });
    })

    function getScenicspotRole(){
        var items = [];
        $.ajax({
            type : "post",
            url : "/system/AppRole/getAppRoleLists",
            async : false,
            success : function(data){
                if(data.state == 200){
                    items = data.data;
                    console.log(items);
                    var htt = '<option value="">请选择</option>';
                    $.each(items, function (k, v) {
                        var a = v.roleId;
                        var b = v.roleName;
                        // console.log(a);
                        // console.log(b);
                        htt += '<option value="'+ a +'">'+b+'</option>'
                    });
                    $("#sele").html(htt);
                }else{
                }
            }
        });
    }
</script>

</body>

</html>
